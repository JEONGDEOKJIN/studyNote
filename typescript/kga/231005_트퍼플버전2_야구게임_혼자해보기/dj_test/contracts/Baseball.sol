// SPDX-License-Identifier: MIT

pragma solidity ^0.8.13;

    /* [ì´ ì»¨íŠ¸ë™íŠ¸ë¥¼ ë°°í¬í•œ ì‚¬ëŒ(ì†Œìœ í•œ ì‚¬ëŒ, ì•¼êµ¬ê²Œì„ ë§Œë“  ì‚¬ëŒ, ì½˜í…ì¸  ì†Œìœ ì)ì˜ ì—­í• ]
        ì´ ì†Œìœ ìëŠ” 
            1) CA ì— ìˆëŠ” balance(ê³„ì • ì”ì•¡)ì„â“â“ ìê¸° ì£¼ì†Œë¡œ ì „ë‹¬
            2) ê²Œì„ ì§„í–‰í•  ë•Œ, reset í•´ì¤Œ
            3) ì†Œìœ ì ê¶Œí•œì„ ê°–ê³  ìˆëŠ” ì‚¬ëŒë§Œ ì‘ì„±í•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜ë¥¼ ì ê²Œ ë¨ 
    */

    /* [ê²Œì„ rule]
        - ì»´í“¨í„°ê°€ ìˆ«ì 3ê°œë¥¼ ëœë¤ìœ¼ë¡œ ë½‘ëŠ”ë‹¤. 
        - í”Œë ˆì´ì–´ëŠ” ìˆ«ìë¥¼ ì…ë ¥ -> 1) ë§ì¶”ë©´ ìƒê¸ˆ, 2) í‹€ë¦¬ë©´, ì´ë”ë¥¼, CA ì— ë³´ë‚¸ë‹¤. | ìƒê¸ˆì´ ëˆ„ì ëœë‹¤. 
        - ê²Œì„ í”Œë ˆì´ íšŸìˆ˜ê°€ ìˆëŠ”ë°, ì•„ë¬´ë„ ëª» ë§ì¶”ë©´, 'ì»¨íŠ¸ë™íŠ¸ ì†Œìœ ì' ê°€ ì´ë”ë¥¼ ê°€ì ¸ê°„ë‹¤. 
    */

    /* [ë“¤ì–´ê°€ê¸° ì „ ê¶ê¸ˆì¦]
        - 'ì»¨íŠ¸ë™íŠ¸ ë°°í¬ì' ê°€ ëˆ„êµ¬ê³ , ë°°í¬ìê°€ ì•„ë‹Œ ì‚¬ëŒìœ¼ ëˆ„êµ¬ê³ , ì–´ë–»ê²Œ êµ¬ë¶„í• ê¹Œ? 
        - public, private ì€ ì•ˆê³¼ ë°–. ì¸ë°, êµ¬ì²´ì ìœ¼ë¡œ ì–´ë””ë¥¼ ì˜ë¯¸í• ê¹Œ?  
        - enum ì´ ë­ì§€? 
    */


contract Baseball {

    // 'ì»¨íŠ¸ë™íŠ¸ ë°°í¬ì' ì˜ ì£¼ì†Œë¥¼ ê°–ê³  ìˆëŠ” ìƒíƒœ ë³€ìˆ˜ 
    address private owner;

    // ê²Œì„ íšŸìˆ˜ 
    uint256 private constant GAMEOVER_COUNT = 5;
        // const : ë³€ìˆ˜ë¥¼ const ë¡œ í•˜ëŠ” ê²ƒê³¼ ë¹„ìŠ· | ì´ êµ¬ë¬¸ì„ ì¶”ê°€í•˜ë©´, ìƒíƒœë¥¼ ë³€ê²½í•˜ì§€ ì•Šì„ ìƒíƒœ ë³€ìˆ˜! ë¼ëŠ” ë§ 

    // ticket : ê²Œì„ì„ í•˜ê³  ì‹¶ìœ¼ë©´ ì§€ë¶ˆí•´ì•¼ í•˜ëŠ” ì´ë”(ether)
    uint256 private ticket = 5 ether;
        // [íŠ¹ì§•] í˜„ì¬, 5 ë¼ê³  ì¼ì§€ë§Œ, â­wei ë‹¨ìœ„ë¡œ ë„˜ì–´ê°„ë‹¤. 

    // random : ì»´í“¨í„°ê°€ ì •í•  ëœë¤ê°’(ì •ë‹µ ì„) | 3ìë¦¬ìˆ˜ì˜ ìˆ«ì 
    uint256 private random;

    // ê²Œì„ì˜ ì§„í–‰ë„ 
    uint256 private progress;

    // ì´ ëª¨ì—¬ìˆëŠ” ìƒê¸ˆ 
    uint256 private reward;

    // ê²Œì„ì˜ í˜„ì¬ ìƒíƒœ | enum : 1) ê°œë°œìê°€ ìƒíƒœê°’ì„ ì‰½ê²Œ ì•Œì•„ë³´ê¸° ìœ„í•´ì„œ ì‚¬ìš©í•¨, 2) â­ì‚¬ìš©ì ì •ì˜ íƒ€ì…â­ì„ ë§Œë“¤ ìˆ˜ ìˆìŒ. 
    enum GameStatus {
        Playing,    // 0
        GameOver   // 1
    }

    // ìµœì´ˆì˜ ìƒíƒœê°’ì€ 0 == ê²Œì„ play ì¤‘!!! ì´ë¼ëŠ” ì˜ë¯¸
    GameStatus gameStatus;
        // [í•´ì„] 
            // â­enum ì„ ì‚¬ìš©í•˜ë©´ -> 'ì‚¬ìš©ì ì •ì˜ íƒ€ì…'â­ ì„ ë§Œë“¤ ìˆ˜ ìˆìŒ! 
            // íƒ€ì…ì´ 'GameStatus' ì¸ gameStatus ìƒíƒœ ë³€ìˆ˜ë¥¼ ì„ ì–¸
            // íƒ€ì…ì´ 'GameStatus' ë¼ë©´, í•´ë‹¹ ë³€ìˆ˜ê°€, Playing ë˜ëŠ” GameOver ê°’ ì¤‘ í•˜ë‚˜ë§Œ ê°€ì§ˆ ìˆ˜ ìˆë‹¤ëŠ” ì˜ë¯¸. 
            // ì´ˆê¸°ê°’ìœ¼ë¡œëŠ”, solidity ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ 0 ìœ¼ë¡œ ì´ˆê¸°í™” ë˜ë¯€ë¡œ -> Playing ìœ¼ë¡œ ì„¤ì •ë¨


    // ì»¨íŠ¸ë™íŠ¸ ìƒì„±ì : 1) owner : ë°°í¬ì ì •ë³´ ë‹´ê²Œ í•˜ê¸° 2) random ê°’ ë½‘ê¸° 
    constructor() {

        // ìµœì´ˆì— ë”± í•œë²ˆ, ë°°í¬ìê°€ ìƒíƒœë³€ìˆ˜ì— ë‹´ê¸´ë‹¤ 
        owner = msg.sender;
            // [ê¶ê¸ˆì¦] msg ëŠ” ì–´ë””ì—ì„œ ì˜¨ê±°ì§€â“â“â“

        // í•´ì‹œê°’ì„ í™œìš©í•´ì„œ ëœë¤ê°’ ë½‘ê¸° 
            // 1) í° ìˆ«ì ë½‘ê¸° 
                random = uint256(
                    keccak256(
                        abi.encodePacked(
                            block.timestamp,
                            block.difficulty, 
                            block.coinbase, 
                            block.number
                        )
                    )
                );
                /* [í•´ì„]
                    - keccak256
                        : ì†”ë¦¬ë””í‹°ì—ì„œ, ëœë¤ê°’ì„ ë½‘ì„ ë•Œ, ì‚¬ìš©í•œë‹¤. 
                        : 'ë§¤ê°œë³€ìˆ˜' ë¥¼ 'í•´ì‹œê°’' ìœ¼ë¡œ ë³€ê²½í•´ì¤€ë‹¤.
                        : SHA-3 ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš©
                    - abi.encodePacked | 
                        : 'ë§¤ê°œë³€ìˆ˜'ë¡œ ì „ë‹¬ëœ ë‚´ìš©ë“¤ì„ ê°€ì§€ê³ , 'ë°”ì´íŠ¸ ë°°ì—´' ë¡œ, ë§Œë“¤ì–´ì¤€ë‹¤. 
                        : ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬ëœ ë‚´ìš© -> ë°”ì´íŠ¸ -> í•´ì‹œê°’ -> uint256 ìœ¼ë¡œ í˜•ë³€í™˜ (â“â“ë§ë‚˜)
                        : ê¶ê¸ˆì¦ | ì—¬ê¸°ëŠ” solidity ì¸ë°, abi ë¼ëŠ”ê²Œ, ì–´ë–»ê²Œ ë“¤ì–´ì˜¬ ìˆ˜ ìˆëŠ”ê±°ì§€â“â“â“ 
                    
                    - block ì´ í¬í•¨í•˜ê³  ìˆëŠ” ë‹¤ì–‘í•œ ê°’ë“¤ì„ ë„£ì–´ì„œ -> ëœë¤ê°’ì˜ ì¬ë£Œê°€ ë˜ê²Œ í•œë‹¤. 
                */

            // 2) í° ìˆ«ìì—ì„œ, ì›í•˜ëŠ” ë§Œí¼ì˜ ìˆ«ì, ë¥¼ ë½‘ê¸° | 100 ~ 999 ì‚¬ì´ì˜ ëœë¤ê°’
            random = (random % 900) + 100;
    
    }

    // ìœ ì €ì˜ ê°’ì„ ë°›ì•„ì„œ -> ë¹„êµ -> ê²Œì„ì˜ ì •ë‹µì„ ë§ì·„ëŠ”ì§€ë¥¼ ê³„ì‚°  
    function gameStart(uint256 _value) public payable {
        
        // 'ê²Œì„ ì§„í–‰ ì¡°ê±´ 1 : ëª‡ íŒ í–ˆë‹ˆ?' í™•ì¸
        require(progress < GAMEOVER_COUNT , "Game Over");
            // [í•´ì„] í˜„ì¬ ì§„í–‰ ì •ë„ê°€, GAMEOVER_COUNT ë³´ë‹¤ ì ìœ¼ë©´ -> ê²Œì„ ì§„í–‰ | ë„˜ìœ¼ë©´, GAME OVER ë„ìš°ê¸°

        // 'ê²Œì„ ì§„í–‰ ì¡°ê±´ 2 : í‹°ê²Ÿ, êµ¬ë§¤í•  ë§Œí¼, ì´ë”ë¦¬ì›€ ìˆë‹ˆ?' í™•ì¸
        require( msg.value == ticket , "ticket amount error (give me 5 ether)" );
            // [ê¶ê¸ˆì¦] ì»¨íŠ¸ë™íŠ¸ë¥¼ ì‹¤í–‰í•œ ì‚¬ëŒì€, msg ê°ì²´ì— ë“¤ì–´ê°€ ìˆë‹¤ê³  í•˜ëŠ”ë°, ë¬´ìŠ¨ ì˜ë¯¸ì§€â“â“â“ | msg ê°ì²´ê°€ ì´í•´ê°€ ì•ˆ ë¼ ğŸ˜¥ğŸ˜¥ğŸ˜¥ 

        // 'ê²Œì„ ì§„í–‰ ì¡°ê±´ 3 : ì…ë ¥ëœ ìˆ«ìê°€ 3ìë¦¬ ì¸ê°€?' í™•ì¸
        require(
            (_value >= 100) && (_value < 1000), "Not between 100 and 999"
        );

        // ê²Œì„ ì§„í–‰ count 1 ì¦ê°€ 
        progress += 1;

        // í”Œë ˆì´ì–´ê°€ ì •ë‹µì„ ë§ì·„ëŠ”ì§€ ë¹„êµ 
            // ì •ë‹µì¸ ê²½ìš° 
            if(_value == random){
                    // CA ì˜ ì”ì•¡(address(this).balance)ì´, ë³´ìƒ(reward) ë§Œí¼ ìˆëŠ”ì§€! ê²€ì‚¬ 
                    require(reward <= address(this).balance);
                        /* [í•´ì„] 
                            - this : ì´ ì»¨íŠ¸ë™íŠ¸ ë¥¼ ì˜ë¯¸ 
                            - address : 'íƒ€ì… ìºìŠ¤íŒ…' ì„ 
                                - íƒ€ì… ìºìŠ¤íŒ… : 'í•˜ë‚˜ì˜ ë°ì´í„° íƒ€ì…' ì„ 'ë‹¤ë¥¸ ë°ì´í„° íƒ€ì…' ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í”„ë¡œì„¸ìŠ¤
                            - address(this) : ì´ ì»¨íŠ¸ë™íŠ¸ì˜ 'ì£¼ì†Œ' ë¥¼ ë°˜í™˜
                            - balance : í•´ë‹¹ ì£¼ì†Œì˜ ì”ì•¡ì„ 'wei' ë‹¨ìœ„ë¡œ ë°˜í™˜ 
                        */

                    // ì •ë‹µì„ ë§ì¶˜ ì‚¬ëŒ(msg.sender) ì—ê²Œ CA ì˜ ì”ì•¡(address(this).balance) ì„ ë³´ìƒìœ¼ë¡œ ì¤€ë‹¤. 
                        // (ê¶ê¸ˆì¦) 'address(this).balance' ì´ê²Œ 'CA ì˜ ì”ì•¡' ì´ ë§ë‚˜â“â“â“ 
                            // CA ê°€ ì•„ë‹ˆë¼, ì§€ê°‘ ì£¼ì†Œ ì—¬ì•¼ í•˜ëŠ” ê±´ ì•„ë‹Œê°€â“â“â“ | ê·¸ëŸ¬ë©´, íƒˆë½í•˜ê³  ë‚¨ì€ ëˆì€ CA ë¡œ ìŒ“ì´ê²Œ ë˜ëŠ” ê±´ê°€â“â“â“ 
                    payable(msg.sender).transfer(address(this).balance);
                        /* [í•´ì„]
                            - msg.sender 
                                : í˜„ì¬ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ì£¼ì†Œ
                                : gameStart í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ í”Œë ˆì´ì–´ì˜ ì£¼ì†Œ
                                : (ê¶ê¸ˆì¦) ì´ ë¶€ë¶„ì´ ì˜ ì´í•´ê°€ ì•ˆ ë¨ ğŸ˜¥ğŸ˜¥ğŸ˜¥ | â“â“â“ 
                            - payable(msg.sender)
                                : solidity ì—ì„œëŠ” â­ê¸°ë³¸ì ìœ¼ë¡œ 'ì´ë”ë¥¼ ë°›ì„ ìˆ˜ ì—†ìŒ'â­ -> ì´ë”ë¥¼ ë°›ìœ¼ë ¤ë©´, 'payable' íƒ€ì…ìœ¼ë¡œ ìºìŠ¤íŒ… í•´ì•¼ í•¨. 
                                : payable(msg.sender) ë¡œ ì´ë”ë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ” ì£¼ì†Œ íƒ€ì…ìœ¼ë¡œ ë³€ê²½í•¨
                            - transfer 
                                : ì´ë”ë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ” ì£¼ì†Œ(payable(msg.sender))ë¡œ, transfer ì˜ ë§¤ê°œë³€ìˆ˜ ë§Œí¼ì˜ ê°’ì„ ì „ë‹¬í•œë‹¤! ë¼ëŠ” ì˜ë¯¸. 
                            - address(this).balance 
                                : í˜„ì¬ ì»¨íŠ¸ë™íŠ¸(this)ì˜ ì£¼ì†Œ(address)ì˜ ì”ì•¡(balance) ë¥¼ ê°€ì ¸ì˜¨ë‹¤. 
                        */  

                    // ë³´ìƒ ê¸ˆì•¡ì„ ì´ˆê¸°í™”
                    reward = 0;

                    // gameStatus ìƒíƒœ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ 
                    gameStatus = GameStatus.GameOver;
                        // [í•´ì„] enum íƒ€ì…ì—ì„œ GameOver ì€ '1' ì„ ì˜ë¯¸. ê²Œì„ì´ ëë‚¬ë‹¤! ëŠ” ê²ƒì„ ì˜ë¯¸ 

            } else {
                // ì •ë‹µì„ ëª» ë§ì·„ìœ¼ë©´, ë¦¬ì›Œë“œë¥¼ ìŒ“ëŠ”ë‹¤. 
                reward += msg.value;
                    // [ê¶ê¸ˆì¦] reward ë³€ìˆ˜ì—, í˜„ì¬ í”Œë ˆì´ì–´ì˜ ê°’ì„ ë„£ëŠ”ê±´ê°€â“â“â“ 
                        // msg : solidity ì—ì„œ ì œê³µí•˜ëŠ” ì „ì—­ ë³€ìˆ˜ | í˜„ì¬ í˜¸ì¶œí•˜ëŠ” íŠ¸ëœì­ì…˜ì— ëŒ€í•œ ì •ë³´ê°€ ìˆìŒ 
                        // msg.value : í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ë•Œ ì „ì†¡í•œ ê°’ 
                        /*  ì§€ê¸ˆ ì½”ë“œì—ì„œëŠ”, ì—¬ê¸°ì—ì„œ ì „ì†¡í•œ ether 5 ì„ ì˜ë¯¸ ğŸ‘‡ğŸ‘‡ğŸ‘‡ 
                            await baseballContract.methods.gameStart(Number(value)).send({
                                from: user.account,
                                value: web3.utils.toWei("5", "ether"),
                            });

                        */

                    // value ëŠ” ìˆ«ìë¥¼ ì°ì€ ê°’ì¸ë°, reward ì—ëŠ” ë‹¤ë¥¸ ê°’ì´ ë“¤ì–´ê°€ì•¼ í•˜ëŠ”ê±° ì•„ë‹ˆì•¼â“â“â“ 
            }
    }
        /* [í•´ì„]
            - _value : ìœ ì €ê°’ì´ ë“¤ì–´ì˜¤ë©´ ë¹„êµ! 
            - payable : ê²°ê³¼ê°’ì´ payable ì¸ ì´ìœ ëŠ”, í‹€ë¦¬ë©´, í•´ë‹¹ ê°’ ë§Œí¼ ì§€ë¶ˆ í•´ì•¼ í•´ì„œ. 

            - ì»¨íŠ¸ë™íŠ¸ê°€ ë°°í¬ë˜ì—ˆì„ ë•Œ, ë”± í•œë²ˆë§Œ! ì‹¤í–‰ë¨. â­â­â­â­â­ 
            - ì´ë•Œ, 'ë°°í¬ ì‹œí‚¨ ì‚¬ëŒ' ì´ 'ì†Œìœ ì' ì¼ ê²ƒ. â­â­â­ 
            - msg : 'ë°°í¬í•œ ì‚¬ëŒ' ì„ ë°›ì„ ìˆ˜ ìˆìŒ. | â“â“â“â“â“â“â“â“â“â“â“â“â“â“
            - ìµœì´ˆ, ë”± í•œë²ˆ, ë°°í¬ìê°€, ìƒíƒœë³€ìˆ˜ì— ë‹´ê¹€. 
        */

    // í˜„ì¬ ìŒ“ì¸ ë³´ìƒì„ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜ 
    function getReward() public view returns (uint256) {
        return reward;
    }
        /* [ê¶ê¸ˆì¦] 
            - getReward() ê°€ ì–¸ì œ ë¶ˆë¦¬ëŠ” ê±°ì§€â“â“â“
                - ì´ê²Œ ì†”ë¦¬ë””í‹°ë‹ˆê¹Œ, ë§ì•„, ë‚˜ì¤‘ì— ë¶ˆë ¤ì ¸ì„œ ë‹¤ë¤„ì§€ê² ì§€? 
            ì ‘ê·¼ ì œí•œì â“â“â“ : public ?
            ì ‘ê·¼ ì§€ì •ì â“â“â“ : view ? 
        */

    // ê²Œì„ì´ ì–¼ë§ˆë‚˜ ì§„í–‰ ëëŠ”ì§€ë¥¼ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜ 
    function getProgress() public view returns (uint256) {
        return progress;
    }

    // í‹°ê²Ÿì˜ ê¸ˆì•¡ì„ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜ 
    function getTicketPrice() public view returns (uint256) {
        return ticket;
    }

    // ì–´ë“œë¯¼ ëª¨ë“œë¡œ ì •ë‹µì„ í™•ì¸í•˜ëŠ” í•¨ìˆ˜ 
    function getRandom() public view returns(uint256) {
        // ì»¨íŠ¸ë™íŠ¸ ë°°í¬í•œ ì‚¬ëŒì¸ì§€ ì—¬ë¶€' ë¥¼ í™•ì¸ â­â­â­ | ğŸ˜¥ğŸ˜¥ğŸ˜¥ ì‘ë™ë˜ëŠ”ì§€ ì•„ì§ ëª¨ë¥´ê² ìŒ. ìˆ˜ì—… ì¤‘ì—ëŠ” ì—ëŸ¬ê°€ ë‚¬ì—ˆìŒ
            require(owner == msg.sender , "admin");

        // ì†Œìœ ìê°€ ë§ìœ¼ë©´, ì •ë‹µì„ í™•ì¸
            return random;
    }

    // ê²Œì„ì¤‘ ì¸ì§€ í™•ì¸í•  í•¨ìˆ˜
    function getPlaying() public view returns (uint256) {
        // ê²Œì„ì´ ì§„í–‰ë˜ê³  ìˆëŠ” ìƒìˆ˜ê°’ì´ 0 
        uint256 Playing = 0;

        if( (gameStatus != GameStatus.Playing) || (progress == GAMEOVER_COUNT) ) {
            // ê²Œì„ ëë‚¬ë‹¤ 
            Playing = 1;
        }
        return Playing;
    }
}