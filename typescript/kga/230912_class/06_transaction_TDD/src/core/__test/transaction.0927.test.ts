
/* test íŒŒì¼ ëŒë ¤ë³´ë ¤ë©´ 

    [âœ… ë³´ì™„í•  ê²ƒ]
        - jest ì„¤ì¹˜ ë° í™˜ê²½ ì„¤ì • ê³¼ì • í•„ê¸° 
        - ì§€ê¸ˆ ì²˜ëŸ¼, ë‹¤ ëë‹¤ê³  ê°€ì •í•˜ê³ 

    1. 'kga/studynote/typescript/kga/230912_class/06_transaction_TDD'ì—ì„œ, npm run test í–ˆìŒ 
        - transaction.ts íŒŒì¼ì´ ìˆëŠ” ê³³ ê¹Œì§€ cd ë¡œ ë‚´ë ¤ê°€ì„œ, ì‹¤í–‰ì‹œí‚¤ì§€ ì•Šì•˜ìŒ. 
        - ì•„ë¬´ë˜ë„, .test ëë‚˜ëŠ” íŒŒì¼ì„ jestë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•´ì„œ ê·¸ëŸ° ê²ƒ ê°™ìŒ. 
        - ì´ëŸ° ë¶€ë¶„ì„, ì´ì œ, docs ì— ì •ë¦¬í•´ì„œ, ë‹¤ìŒì— í…ŒìŠ¤íŠ¸ í•  ë•Œ, í¸í•˜ê²Œ í•  ìˆ˜ ìˆì–´ì•¼ í•¨. â­â­

    2. í˜„ì¬, transaction.test.ts ë§Œ ë³€ê²½í•˜ê³  ì‹¶ì–´ì„œ, package.json ì„     
        "test": "jest transaction.test.ts" ì´ë ‡ê²Œ ë³€ê²½

    */



/* ê²€ì¦ ëª©í‘œ : DJ ê°€ A ì—ê²Œ 100 ì½”ì¸ ì†¡ê¸ˆì˜ íë¦„ì„ ê²€ì¦í•˜ê³  ì‹¶ìŒ 

    ê²€ì¦ ìˆœì„œ 
        1) DJ, A ê°ê°ì˜ ì§€ê°‘ì„ ë§Œë“¤ì–´ ë‘ê¸° 
            - UTXO ë„ ìˆì–´ì•¼? 

        2) íŠ¸ëœì­ì…˜ì„ ë°œìƒ ì‹œí‚¤ê¸° 
*/


/* êµìˆ˜ë‹˜ì´ ì£¼ì‹  í…ŒìŠ¤íŠ¸ íë¦„ (230919_ì´ë”ë¦¬ì›€ íŒŒì¼ì—ì„œ ê°€ì ¸ì˜´)
    # í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±
        1. ì§€ê°‘ì„ ìƒì„±
        
        2. ì§€ê°‘ì£¼ì†Œë¡œ ë¸”ë¡ì„ ìƒì„±(ë§ˆì´ë‹)   
            | ğŸ˜¥ ì´ ë‹¨ê³„ë¥¼ ìƒê° ëª» í–ˆì–´ 
            | ì´ íë¦„ì„ ì˜ ì´í•´ í•´ì•¼ í•´ â­â­â­â­â­â­â­â­ ì—¬ê¸°ì„œ ë¶€í„° ë¶€ì¡±í•´ â­â­â­â­â­â­â­ 

        3. ë¸”ë¡ì˜ ì±„êµ´ë³´ìƒì„ ì´ ì§€ê°‘ì´ ë°›ê³ (ì½”ì¸ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ì„ ë¸”ë¡ ì¶”ê°€)

        4. UTXO ì±„êµ´ì ì§€ê°‘ì˜ ê³„ì •ê³¼ ë¸”ë¡ ì±„êµ´ ë³´ìƒ

        5. ìƒˆë¡œìš´ ì§€ê°‘ì„ í•˜ë‚˜ë” ë§Œë“¤ì–´ì„œ

        6. ì±„êµ´ë³´ìƒì„ ë°›ì€ ì§€ê°‘ì—ì„œ ìƒˆë¡œìš´ ì§€ê°‘ìœ¼ë¡œ ëˆì„ ì†¡ê¸ˆ íŠ¸ëœì­ì…˜ì„ ë°œìƒ

        7. ì„œëª…ì´ ìœ íš¨í•œì§€ ê²€ì¦ì„ ê±°ì¹˜ê³  íŠ¸ëœì­ì…˜ í’€ì— ë‹´ì•„ë†“ê³  ë°œìƒí•œ íŠ¸ëœì­ì…˜

        8. ìƒˆë¡œìš´ ì§€ê°‘ì´ ë¸”ë¡ ë§ˆì´ë‹í•´ì„œ(ì½”ì¸ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ì„ ì¶”ê°€)(íŠ¸ëœì­ì…˜ í’€ì—ìˆëŠ” íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬)

        9. UTXOì— ì²˜ìŒë§Œë“  ì§€ê°‘ì´ ì „ì†¡í•œ ì”ì•¡ì´ ìƒˆë¡œìš´ ì§€ê°‘ì— ì”ì•¡ìœ¼ë¡œ ë¯¸ì‚¬ìš© ê°ì²´ê°€ ì¶”ê°€ë ìˆ˜ ìˆê²Œ.
*/


/* ì´ íë¦„ëŒ€ë¡œ, â­unspent ê°™ì€ ê³³ì—ì„œ ë©”ì†Œë“œë¥¼ ê°€ì ¸ì™€ì„œâ­, ë§Œë“ ë‹¤. 
    // ì§€ê°‘ì„ ìƒˆë¡œ í•˜ë‚˜ ë§Œë“¤ê³ 
        // ì§€ê°‘ì˜ ì£¼ì†Œë¥¼ ê°€ì§€ê³ ìˆê³ 
        // íŠ¸ëœì­ì…˜ì„ ë§Œë“¤ì–´ì„œ ë¸”ë¡ì— ì¶”ê°€í•˜ê³  ë§ˆì´ë‹ì„ í•´ì„œ ë¸”ë¡ì˜ ì±„êµ´ ê¶Œí•œì„ ì–»ê³ 
        // ì½”ì¸ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ ë‚´ìš©ì˜  ì¶œë ¥ì˜ ë‚´ìš©ì„ UTXO ì¶”ê°€(ë¸”ë¡ë³´ìƒ)({ì§€ê°‘ ì£¼ì†Œ : ì±„êµ´ ë³´ìƒ})

        // ì§€ê°‘ì„ í•˜ë‚˜ë” ë§Œë“¤ì–´ì„œ

        // ì²˜ìŒì— ë§Œë“  ì§€ê°‘ì—ì„œ íŠ¸ëœì­ì…˜ì„ ë°œìƒì‹œí‚¤ê³  -> ì²˜ìŒ ë§Œë“  ì§€ê°‘ì—ì„œ ë‘ë²ˆì§¸ë¡œ ë§Œë“  ì§€ê°‘ì— ì½”ì¸ ì „ì†¡
        // íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì‘ì„± (ì²«ë²ˆì§¸ ì§€ê°‘ì´ ë³´ë‚´ëŠ” ì‚¬ëŒ ë‘ë²ˆì§¸ ì§€ê°‘ì´ ë°›ëŠ”ì‚¬ëŒ ì„œëª…)
        // íŠ¸ëœì­ì…˜ ìƒì„± (UTXOì—ì„œ ì²«ë²ˆì§¸ ì§€ê°‘ì˜ ì”ì•¡ ì¡°íšŒ)
        // íŠ¸ëœì­ì…˜ í’€ì— ë‚´ìš©ì´ ì¶”ê°€
        // ë‘ë²ˆì§¸ ì§€ê°‘ì´ ë¸”ë¡ ë§ˆì´ë‹ì„ í•˜ê³  ë¸”ë¡ì˜ ë‚´ìš©ì—ëŠ” ì½”ì¸ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ê³¼ ì²«ë²ˆì§¸ ì§€ê°‘ì´ ë‘ë²ˆì§¸ ì§€ê°‘ì— ëˆì„ ì „ì†¡í•œ ë‚´ìš©ì˜ íŠ¸ëœì­ì…˜
        // ë¸”ë¡ì„ ìƒì„±ì„ í•˜ê³  í’€ì— ìˆëŠ” íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬
        // í’€ì—ì„œ í•´ë‹¹ íŠ¸ëœì­ì…˜ì„ ì œê±°í•˜ê³ 
        // ì²«ë²ˆì§¸ ì§€ê°‘ì˜ ì”ì•¡ì„ ì‚¬ìš©í–ˆìœ¼ë‹ˆê¹Œ UTXOì—ì„œ ê°ì²´ë¥¼ ì œê±°
        // outì— ìˆëŠ” ê°ì²´ë¥¼ UTXOì— ì¶”ê°€{ì²«ë²ˆì§¸ ì§€ê°‘: ë‚¨ì€ ê¸ˆì•¡}{ë‘ë²ˆì§¸ ì§€ê°‘ : ë°›ì€ ê¸ˆì•¡
        */
    
    /*  ğŸ‘‡ ì´ë ‡ê²Œ ê°€ì ¸ì™€ì„œ ë©”ì†Œë“œ ì“°ë©´ ë¨. 
        // í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‹¤í–‰ ì „ì— ì‹¤í–‰ë˜ëŠ” ì½”ë“œ
        beforeEach(()=>{
        transaction = new Transaction();
        })

        describe("createTxOut", ()=>{
        const account = "0".repeat(40);
        it("txOut ìƒì„±", () => {
            // ì„ì‹œ ë³´ë‚´ëŠ” ê°’
            const amount = 40;

            // íŠ¸ëœì­ì…˜ ê°ì²´ë¥¼ ì‚¬ìš©
            // txOutê°ì²´ í•˜ë‚˜ ìƒì„±
            const txout = transaction.createTxOut(account, amount);

            console.log(txout);
            expect(txout.account).toBe(account);
            expect(txout.amount).toBe(amount);
        })
        })
    })
    */
        
        




import { randomBytes, sign } from "crypto";   // ê°œì¸í‚¤ ìƒì„± ìœ„í•´ í•„ìš”í•œ ëœë¤ê°’ ìƒì„± ë©”ì†Œë“œ
import elliptic from "elliptic"         // 'íƒ€ì› ê³¡ì„  ì•Œê³ ë¦¬ì¦˜' ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ, ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ê°€ì ¸ì˜¤ê¸°  
import { SHA256 } from "crypto-js";     // í•´ì‹œí™” í•´ì£¼ëŠ” SHA256
import Transaction from "@core/transaction/transaction";    // íŠ¸ëœì­ì…˜ ê°€ì ¸ì˜¤ê¸°

import Unspent from "@core/transaction/unspent";
import { TxOut } from "@core/transaction/transaction.interface";
import Chain from "@core/chain/chain";
import { Block } from "@core/block/block";
import { GENESIS } from "@core/config";



const ec = new elliptic.ec('secp256k1')     // 'secp256k1' ë³„ëª…ì„ ê°€ì§€ íƒ€ì› ê³¡ì„  ì¸ìŠ¤í„´ìŠ¤ ìƒì„±





describe( "ì§€ê°‘ ë§Œë“¤ê¸°" , () => {

    let privKey : string;
    let pubKey : string;
    let signature : elliptic.ec.Signature;

    it("ê°œì¸í‚¤ ìƒì„±" , () => {
        // 2ì§„ìˆ˜ì˜ ëœë¤ê°’ìœ¼ë¡œ ê°œì¸í‚¤ ìƒì„± | 16ì§„ìˆ˜ë¡œ ë‚˜íƒ€ëƒ„ | 
        privKey = randomBytes(32).toString("hex")
        console.log("ê°œì¸í‚¤" , privKey)
        console.log("ê°œì¸í‚¤ ê¸¸ì´" , privKey.length)
    })
    /* publicKey = G(ê¸°ì¤€ì ) * privateKey ì´ê¸° ë•Œë¬¸ì— -> privateKey ë§Œë“¤ê³  -> ì´ê±¸ë¡œ ê³µê°œí‚¤ ë§Œë“ ë‹¤. 

    */

    it("ê³µê°œí‚¤ ìƒì„±" , () => {
        // ê³µê°œí‚¤ ìƒì„± | íƒ€ì› ê³¡ì„  ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© | keyPair ì•ˆì— 'ê³µê°œí‚¤ + ê°œì¸í‚¤' ê°€ ì§ìœ¼ë¡œ ìˆìŒ | ì§ê¶ì´ ë‹¤ë¥´ë©´, false ê°€ ë‚˜ì˜¤ëŠ” ì‹
        const keyPair = ec.keyFromPrivate(privKey)

        // hex ë¡œ ë³€í™˜ | ê°œì¸í‚¤ë¡œ ê³µê°œí‚¤ë¥¼ ìƒì„±! | compact ë§¤ê°œë³€ìˆ˜ : false ë©´ 130 ê¸€ì,  true ë©´ 66 |  
        pubKey = keyPair.getPublic().encode("hex" , true)

        console.log("ê³µê°œí‚¤" , pubKey)
        console.log("ê³µê°œí‚¤ ê¸¸ì´" , pubKey.length)
    })

    it("ì„œëª… ë§Œë“¤ê¸°" ,  () => {
        // íƒ€ì› ê³¡ì„  ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°€ì ¸ì™€ì„œ, ê°œì¸í‚¤ë¡œ, ê³µê°œí‚¤ì™€ ìŒì¸ keyPair ë§Œë“¦ | ê°œì¸í‚¤, ê³µê°œí‚¤ ëª¨ë‘ í¬í•¨
        const keyPair = ec.keyFromPrivate(privKey)

        // íŠ¸ëœì­ì…˜ì´ ì—†ê¸° ë•Œë¬¸ì— ì„ì‹œì˜ ë¬¸ìì—´ì„ ì•”í˜¸í™” í•´ì„œ ì‚¬ìš© | ì´ê±¸ ì´ë ‡ê²Œ data ë¡œ ì ë‚˜â“â“â“  
        const hash = SHA256("DJ ê°€ MJ ì—ê²Œ 100 ì½”ì¸ ì¤Œ").toString()

        // sign ì„œëª… ìƒì„± | ê°œì¸í‚¤ë¥¼ ê°€ì§€ê³  ì„œëª…ì„ ë§Œë“¦ 
        signature = keyPair.sign(hash , "hex")

        // ì„œëª… êµ¬ì„± ìš”ì†Œ í™•ì¸ 
        console.log("ì„œëª… : " , signature)
    })

    it("ì„œëª… ê²€ì¦í•˜ê¸°" , ( ) => {
        // 'ê²€ì¦í•  ë•Œ ë°›ëŠ” ê²ƒ 1) message 2) ê³µê°œí‚¤ 3) ì„œëª…' ì´ê²Œ ë§ë‚˜â“â“â“ 

        // 'ì„œëª…' í•  ë•Œ ë§Œë“  íŠ¸ëœì­ì…˜ ê·¸ëŒ€ë¡œ 
        const hash = SHA256("DJ ê°€ MJ ì—ê²Œ 100 ì½”ì¸ ì¤Œ").toString()

        // ì„œëª… ê²°ê³¼, ê³µê°œí‚¤, í•´ì‹œí™”ëœ message ë¥¼ ë„£ì–´ì„œ -> ì„œëª… ê²€ì¦ 
        const verify = ec.verify(hash, signature, ec.keyFromPrivate(privKey , "hex"))
            /*  hash = ë©”ì‹œì§€ 
                ec.keyFromPrivate(privKey , "hex") = ê³µê°œí‚¤
                signature = ì„œëª…
            */
        console.log("ê²€ì¦ ì—¬ë¶€ í™•ì¸" , verify)
    })
        /* ì„œëª… ê²€ì¦ë˜ëŠ” ê³¼ì • 
            - ê²€ì¦ìê°€ ê°–ê³  ìˆëŠ” ê±´ 1) message 2) ê³µê°œí‚¤ 3) ì„œëª… ê²°ê³¼ ì„. 
                'U1 * G + U2 * public key' ì´ ê³µì‹ì„ í™œìš©í•´ì„œ, 
                'ì„œëª… r ê°’' ê³¼ ë™ì¼í•œ ê°’ì´ ë‚˜ì˜¤ë©´ -> ê²€ì¦ëœ ê±°ë¼ê³  ê°€ì •.
        */

    it("ì§€ê°‘ ì£¼ì†Œ" , () => {
            /* - ê³„ì •(ê³„ì¢Œ) ë§Œë“œëŠ” ë°©ë²•
                - ê³µê°œí‚¤ì˜ ê°’ì—ì„œ, 26ê°œì˜ ë¬¸ìì—´ì„, ì•ì—ì„œ ì˜ë¼ì„œ, 40ìë¦¬ ë§Œí¼ì„ ë‚¨ê²¨ì„œ, ì£¼ì†Œë¡œ ì‚¬ìš©

                - ì£¼ì†Œ ë§Œë“œëŠ” ë²•
                    - ë¶ˆí•„ìš”í•œ ë¶€ë¶„ ì œê±°í•˜ê³ , ì£¼ì†Œ ì•ì— 0x ë¥¼ ë¶™ì¸ë‹¤. ê·¸ ì´ìœ ëŠ” 'ê°€ë…ì„±' ì„ ìœ„í•´
                    - 16ì§„ìˆ˜ì˜ ì§€ê°‘ ì£¼ì†Œë‹¤! ë¼ëŠ” ì˜ë¯¸
            */

            // ì£¼ì†Œ ë§Œë“¤ê¸° 
            const address = pubKey.slice(26).toString()
            console.log("ì§€ê°‘ ì£¼ì†Œ : " , `0x${address}`)
    })

} )


describe ( "block ê²€ì¦" , () => {
    
    let newBlock : Block;
    let newBlock2 : Block;
    let newChain : Chain;
    let newChain2 : Chain;

    it("ë¸”ë¡ ì¶”ê°€" , () => {

        // ì´ ë¸”ë¡ì— ë„£ì€ ë°ì´í„°ë¥¼ ë§Œë“ ë‹¤. 
        const data = ["ë¸”ë¡ 1"];

        // ìƒˆë¡œìš´ ë¸”ë¡ì„ ìƒì„±
        newBlock = Block.generateBlock(GENESIS , data, GENESIS)
            // [í•´ì„] ì´ì „ ë¸”ë¡ì€ GENESIS ì—ì„œ ê°€ì ¸ì˜¨ë‹¤. 
            // 'hash ê°’ ë§¨ ì²˜ìŒ ë¶€í„° ë‚˜ì˜¤ëŠ” 0 ì˜ ê°œìˆ˜' ê°€ 'ë¸”ë¡ ë‚œì´ë„' ì— ë§ì„ ë•Œ ê¹Œì§€ ë°˜ë³µí•´ì„œ ëŒë¦°ë‹¤. ê·¸ ê²°ê³¼ nonce ê°’ì´ ë‚˜ì˜¤ê³ , ê·¸ëŸ¬ë©´ ì±„êµ´ ì™„ë£Œ 
        console.log(newBlock)
    })

    it("ë¸”ë¡ ìœ íš¨ì„± ê²€ì¦. ì´ ë¸”ë¡ì´ ì •ìƒì ì¸ ë¸”ë¡ì¸ì§€ë¥¼ ê²€ì¦" , () => {
        const isValidNewBlock = Block.isValidNewBlock(newBlock , GENESIS)

        // 'isValidNewBlock.isError == false' ì¸ì§€ ì—¬ë¶€ë¥¼ ê²€ì¦ 
        expect(isValidNewBlock.isError).toBe(false);

    })

    it("ë¸”ë¡ ì²´ì¸ ì¶”ê°€" , () => {
        // Chain ì¸ìŠ¤í„´ìŠ¤ ìƒì„± 
        newChain = new Chain();

        // ìœ„ì—ì„œ ë§Œë“  ë¸”ë¡ì„, chain ì— ì¶”ê°€ 
        newChain.addToChain(newBlock)
        console.log( "newChain.get()" , newChain.get())     // ì „ì²´ ì²´ì¸(blockë“¤ì˜ ë°°ì—´) í™•ì¸
        console.log("getBlockByHeight" , newChain.getBlockByHeight(1))   // block ë“¤ ì¤‘ì—ì„œ, ë†’ì´ê°€ 1 ì¸ ê°’, ì„ ê°€ì ¸ì˜¤ê¸°
        /* [ì‹¤í–‰ìˆœì„œ]
            1. getBlockByHeight ì— ë§¤ê°œë³€ìˆ˜ 1 ì´ ë“¤ì–´ê° 
            2. getBlockByHeight í•¨ìˆ˜ì—ì„œ this ê°€ í™•ì •ë˜ê³  -> ë§¤ê°œë³€ìˆ˜ê°€ í™•ì •ëœ ìƒí™©ì—ì„œ getBlock ì´ í˜¸ì¶œ 
            3. getBlock ì—ì„œ this í™•ì • -> chain ì´ ë°°ì—´ì´ë¼ëŠ” ê²Œ í™•ì • -> find ë©”ì†Œë“œ ë¥¼ ë§Œë‚˜ì„œ ë°°ì—´ì„ í•˜ë‚˜ì”© ì½œë°±í•¨ìˆ˜ë¡œ ë˜ì ¸ì„œ 'ì½œë°±í•¨ìˆ˜' ë¥¼ ì‹¤í–‰
        */
    })

    it("ë„¤íŠ¸ì›Œí¬ ì²´ì¸ ë¹„êµ(longest chain rule" , () => {
        newChain2 = new Chain();
        console.log("newChain2" , newChain2.get())  // 1ê°œë§Œ ë‚˜ì˜´ 

        newChain2.replaceChain(newChain.get())  // ì²« ë²ˆì§¸ chain ì´ ë” ê¸¸ê¸° ë•Œë¬¸ì—, chain2 ëŠ” chain ê²ƒì„ ê°ˆì•„ ë¼ì›€ 
        console.log("newChain2" , newChain2.get())      // 2ê°œ ë‚˜ì˜´ 
    })

}  )