import { useState, useEffect } from "react";

import Web3 from "web3";
// npm i web3 | â­â­â­ ì´ë ‡ê²Œ ê¹”ë”í•˜ê²Œ ì¨ë†”ë„, ëœë‹¤

// Web3 custom hook | âœ… custom hook ì‘ì„±ì‹œ use ë¶™ì—¬ì•¼ í•¨
const useWeb3 = () => {
  // í˜„ì¬ ì ‘ì†í•œ ë©”íƒ€ ë§ˆìŠ¤í¬ ì§€ê°‘ ì •ë³´ë¥¼ ë‹´ì„ ë³€ìˆ˜
  const [user, setUser] = useState({
    account: "",
    balance: "",
  });
  // ì§€ê¸ˆ ì ‘ì†ëœ ì§€ê°‘ ì •ë³´ë‘, web3 ì—°ê²°ëœ ê²ƒ! ì„ ê°–ê³  ìˆì„ ê²ƒ ì„. â“â“â“
  // ìœ ì €ê°€ ì ‘ì†í•˜ë©´ ì—¬ê¸°ì— ì €ì¥â“â“â“

  // ë„¤íŠ¸ì›Œí¬ì™€ ì—°ê²°í•œ web3 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë‹´ì„ ë³€ìˆ˜
  const [web3, setWeb3] = useState(null);

  useEffect(() => {
    // ë©”íƒ€ë§ˆìŠ¤í¬ê°€ ì„¤ì¹˜ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ê¸° | 'window.ethereum' ì•ˆì—, ë„¤íŠ¸ì›Œí¬ ì •ë³´, ì§€ê°‘ë“¤ì´ ë“¤ì–´ê°€ ìˆìŒ -> so, ë©”íƒ€ë§ˆìŠ¤í¬ê°€ ìˆë‹¤ë©´, ë¹ˆ ê°’ì´ ì•„ë‹ ê²ƒ -> so, window.ethereum ìœ¼ë¡œ íŒë³„ ê°€ëŠ¥
    if (window.ethereum) {
      // ë¡œê·¸ì¸
      window.ethereum
        .request({
          method: "eth_requestAccounts",
        })
        /* - window.ethereum.request 
                            : window.ethereum ê°ì²´ ì•ˆì— ìˆëŠ”, request ë©”ì†Œë“œë¥¼ ì“°ê² ë‹¤ëŠ” ë§ 
                            : 'Ethereum JSON-RPC ë©”ì„œë“œ' ì´ì œ ì“¸ê²Œ~ ë¼ëŠ” ì˜ë¯¸
                        - method : "eth_requestAccounts" 
                            : êµ¬ì²´ì ìœ¼ë¡œ, eth_requestAccounts ì´ë¦„ì˜ ë©”ì„œë“œë¥¼ ì‚¬ìš©í• ê²Œ ë¼ëŠ” ë§
                            : 'ì´ë”ë¦¬ì›€ ë„¤íŠ¸ì›Œí¬' ì•ˆì—ì„œ, 'ì‚¬ìš©ìê°€ ìŠ¹ì¸'í•œ, 'ì§€ê°‘ ì£¼ì†Œë“¤'ì´ ë‚˜ì˜´
                            : EX) ë©”íƒ€ë§ˆìŠ¤í¬ì—ì„œ 'ìŠ¹ì¸' ì„ ëˆŒëŸ¬ì„œ, ë””ì•± ë˜ëŠ” ì›¹ì‚¬ì´íŠ¸ì—, ì´ë”ë¦¬ì›€ ì§€ê°‘ ì£¼ì†Œ ì œê³µì„, í—ˆìš©í•œ ì§€ê°‘ ì£¼ì†Œë“¤ì„ ì˜ë¯¸
                    */
        .then(async ([walletAddress]) => {
          /* async ([data]) ì¤‘ [data] í•´ì„ 
                        'ë°›ì•„ì˜¨ ë°°ì—´' ì¤‘ 'ì²« ë²ˆì§¸ ìš”ì†Œ' ë¥¼ data ë³€ìˆ˜ ì— í• ë‹¹
                        data ì—ëŠ” 'ì§€ê°‘ ì£¼ì†Œ' ê°€ ë‹´ê²¨ì ¸ ìˆì–´ì•¼ í•¨
                    */

        // web3 ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
            const web3Provider = new Web3(window.ethereum);
            /* [í•´ì„] 
                            web3 ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í†µí•´, ì´ë”ë¦¬ì›€ ë„¤íŠ¸ì›Œí¬ê³¼ í†µì‹ , ì´ë”ë¦¬ì›€ ë„¤íŠ¸ì›Œí¬ ì•ˆì— ìˆëŠ” ì»¨íŠ¸ë™íŠ¸ì™€ í†µì‹ í•˜ê³ , íŠ¸ëœì­ì…˜ì„ ìƒì„±/ì „ì†¡ í•  ìˆ˜ ìˆìŒ. 
                            web3 ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì—°ê²°í•˜ëŠ” ë°©ë²•ì€ ì—¬ëŸ¬ê°€ì§€ ì„ (ganache ë¡œ í•  ìˆ˜ë„ ìˆê³ , ë¸Œë¼ìš°ì € ì•ˆì— ìˆëŠ” ë©”íƒ€ë§ˆìŠ¤í¬ë¡œ í•  ìˆ˜ë„ ìˆê³ )
                            ê·¸ëŸ¬ë©´, ì§€ê¸ˆì€ 'window.ethereum ì•ˆì— ìˆëŠ” ë©”íƒ€ë§ˆìŠ¤í¬' ë°©ì‹ìœ¼ë¡œ web3 ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì—°ë™ í•œë‹¤ëŠ” ë§ ì„. 
                            ê²°êµ­, 'ë©”íƒ€ë§ˆìŠ¤í¬ë¡œ ì—°ë™ì‹œí‚¨ web3 ë¼ì´ë¸ŒëŸ¬ë¦¬' ë¥¼ í†µí•´ 'ì´ë”ë¦¬ì›€ ë„¤íŠ¸ì›Œí¬' ì™€ 'í†µì‹ ' í•˜ê²Œ ëœë‹¤. â­â­â­ 
                        */

          // set ë©”ì†Œë“œì— ë„£ì–´ì£¼ê¸°
            /* ì´ ìˆœê°„, 'const web3Provider' ì— ë¨¸ë¬´ë¥´ì§€ ì•Šê³ , useState ë¡œ ê´€ë¦¬í•˜ëŠ” ì´ìœ  
                    1) ì»´í¬ë„ŒíŠ¸ ì¬ì‹¤í–‰ì— ë”°ë¼ì„œ -> ë¡œì»¬ ë³€ìˆ˜ê°€ ì´ˆê¸°í™” ë˜ì–´ì„œ -> web3Provider ì— í• ë‹¹ë˜ëŠ” ê°’ì´ ë³€ê²½ë˜ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•´
                    2) ì¶”ê°€ì ìœ¼ë¡œ, íŠ¹ì • ë³€ìˆ˜ì˜ ì •ë³´ê°€ ë³€í–ˆì„ ë•Œë§Œ, ì¬ë Œë”ë§ ë˜ê²Œ í•  ìˆ˜ ìˆìŒ.
                    */
                  
                setUser({
                    // ì§€ê°‘ ì£¼ì†Œê°€ ë‹´ê²¨ ìˆì–´ì•¼ í•¨
                    account: walletAddress, // ì§€ê°‘ ì£¼ì†ŒëŠ”, 'privatekey -> ê³µê°œí‚¤ -> 20ë°”ì´íŠ¸' ì˜ ìˆœì„œë¡œ ë§Œë“¤ì–´ì§€ëŠ” ê²ƒ
                    balance: web3Provider.utils.toWei(
                      await web3Provider.eth.getBalance(walletAddress),
                      "ether"
                      ),
                      // [í•´ì„] web3 ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë‹¤ë…€ì˜¬ ë•Œ, await ë¡œ ê¸°ë‹¤ë¦¬ê²Œ í•´ì•¼ í•œë‹¤ëŠ” ê²ƒ â­â­â­
                    });
                      
                      
                setWeb3(web3Provider);
                    });
                  } else {
      alert("ë©”íƒ€ ë§ˆìŠ¤í¬! ì„¤ì¹˜! í•˜! ì…ˆ! ğŸ˜¸");
    }
  }, []);

  return {
    user,
    web3,
  };
};

export default useWeb3;
